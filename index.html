<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Edward R. Mur-Wren</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23667eea'/><stop offset='100%' style='stop-color:%23764ba2'/></linearGradient></defs><rect x='35' y='20' width='30' height='40' rx='15' fill='url(%23g)'/><rect x='42' y='60' width='16' height='8' fill='url(%23g)'/><rect x='30' y='68' width='40' height='4' rx='2' fill='url(%23g)'/><circle cx='44' cy='35' r='3' fill='white' opacity='0.6'/><circle cx='56' cy='35' r='3' fill='white' opacity='0.6'/><path d='M 35 45 Q 50 50 65 45' stroke='white' stroke-width='2' fill='none' opacity='0.6'/></svg>" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 40px 20px;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .branding {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 32px;
      border-bottom: 3px double #e2e8f0;
    }
    .branding h1 {
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 2.5em;
      font-weight: 400;
      letter-spacing: 0.05em;
      margin: 0 0 12px 0;
      color: #1e293b;
      text-transform: uppercase;
      position: relative;
    }
    .branding h1::before,
    .branding h1::after {
      content: '‚óÜ';
      color: #667eea;
      margin: 0 16px;
      font-size: 0.6em;
    }
    .tagline {
      font-family: Georgia, 'Times New Roman', serif;
      font-style: italic;
      color: #667eea;
      font-size: 1.1em;
      margin: 8px 0 0 0;
    }
    .vintage-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 16px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-top: 12px;
    }
    .subtitle {
      color: #64748b;
      font-size: 1.05em;
      margin: 0 0 32px 0;
      text-align: center;
    }
    fieldset {
      border: none;
      background: #f8fafc;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    fieldset legend {
      font-weight: 600;
      font-size: 1.1em;
      color: #1e293b;
      padding: 0 8px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 500;
      color: #475569;
      font-size: 0.9em;
      white-space: nowrap;
    }
    .row {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }
    .slider-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 280px;
    }
    .slider-group label {
      margin: 0;
      min-width: 110px;
    }
    select {
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      background: white;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    select:hover {
      border-color: #667eea;
    }
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    button {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1em;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    input[type="range"] {
      width: 200px;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      transition: all 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    input[type="file"] {
      padding: 10px;
      border: 2px dashed #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }
    input[type="file"]:hover {
      border-color: #667eea;
      background: #f8fafc;
    }
    .muted {
      color: #94a3b8;
      font-size: 0.9em;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 24px;
    }
    a#dl {
      color: #667eea;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
    }
    a#dl:hover {
      color: #764ba2;
      text-decoration: underline;
    }
    span[id$="Label"] {
      font-weight: 600;
      color: #1e293b;
      min-width: 45px;
      text-align: right;
    }

    /* Mobile message */
    .mobile-message {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }
    .mobile-message h2 {
      font-size: 1.5em;
      margin-bottom: 16px;
      color: #1e293b;
    }
    .mobile-message p {
      color: #64748b;
      font-size: 1.1em;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .mobile-message .icon {
      font-size: 4em;
      margin-bottom: 20px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 20px 12px;
      }
      .mobile-message {
        display: block;
      }
      .main-content {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="mobile-message">
      <div class="icon">üñ•Ô∏è</div>
      <h2>Desktop Required</h2>
      <p>This broadcast audio tool works best on desktop browsers.</p>
      <p>Please visit this page on your computer for the full experience.</p>
      <div style="margin-top: 32px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <p style="font-size: 0.9em; color: #64748b; margin: 0;">
          <strong>Edward R. Mur-Wren</strong><br>
          "Good night, and good chirp."
        </p>
      </div>
    </div>

    <div class="main-content">
      <div class="branding">
        <h1>Edward R. Mur-Wren</h1>
        <p class="tagline">"Good night, and good chirp."</p>
        <div class="vintage-badge">Broadcast Audio Tool</div>
      </div>
      <p class="subtitle">Drop a voice file ‚Üí choose a preset ‚Üí Preview ‚Üí Render WAV. Everything stays in your browser.</p>

    <fieldset>
      <legend>Audio File</legend>
      <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <input id="file" type="file" accept="audio/*" style="flex: 1; min-width: 200px;" />
        <button id="loadSampleBtn" type="button" style="background: #10b981; flex-shrink: 0;">Load Sample Audio</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Preset</legend>
    <div class="row">
      <select id="preset">
        <option value="raw">Raw / No Processing</option>
        <option value="newsroom">Newsroom (subtle slapback)</option>
        <option value="oldtv">Old TV / AM Radio (mono, narrowband)</option>
        <option value="oldtv_hiss">Old TV + light hiss</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="slider-group">
        <label>Echo delay (ms)</label>
        <input id="delayMs" type="range" min="20" max="140" step="1" value="20" />
        <span id="delayLabel">20</span>
      </div>
      <div class="slider-group">
        <label>Echo wet mix</label>
        <input id="wet" type="range" min="0" max="1" step="0.01" value="0.00" />
        <span id="wetLabel">0.00</span>
      </div>
    </div>

    <div class="row">
      <div class="slider-group">
        <label>Feedback</label>
        <input id="fb" type="range" min="0" max="0.9" step="0.01" value="0.00" />
        <span id="fbLabel">0.00</span>
      </div>
      <div class="slider-group">
        <label>High-pass (Hz)</label>
        <input id="hp" type="range" min="20" max="800" step="10" value="20" />
        <span id="hpLabel">20</span>
      </div>
    </div>

    <div class="row">
      <div class="slider-group">
        <label>Low-pass (Hz)</label>
        <input id="lp" type="range" min="1000" max="8000" step="50" value="8000" />
        <span id="lpLabel">8000</span>
      </div>
      <div class="slider-group">
        <label>Hiss level</label>
        <input id="hiss" type="range" min="0" max="0.3" step="0.01" value="0.00" />
        <span id="hissLabel">0.00</span>
      </div>
    </div>
    <div style="margin-top: 4px;">
      <span class="muted" style="font-size: 0.85em;">Hiss only used by "Old TV + hiss" preset</span>
    </div>
  </fieldset>

    <div class="controls">
      <button id="previewBtn" disabled>‚ñ∂Ô∏é Preview</button>
      <button id="stopBtn" disabled>‚ñ† Stop</button>
      <button id="renderBtn" disabled>‚§ì Render WAV</button>
      <a id="dl"></a>
    </div>

      <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #94a3b8; font-size: 0.9em;">
        <a href="https://github.com/sparrowfm/edward-r-mur-wren" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">View on GitHub</a>
        <span style="margin: 0 8px;">‚Ä¢</span>
        <span>Good night, and good chirp. üéôÔ∏è</span>
      </footer>
    </div><!-- end main-content -->
  </div>

  <script>
    // --- Small helper: write a WAV file from an AudioBuffer (16-bit PCM, little-endian)
    function audioBufferToWavBlob(buffer) {
      const numCh = buffer.numberOfChannels;
      const sampleRate = buffer.sampleRate;
      const numFrames = buffer.length;
      const bytesPerSample = 2;
      const blockAlign = numCh * bytesPerSample;
      const dataSize = numFrames * blockAlign;
      const bufferSize = 44 + dataSize;
      const ab = new ArrayBuffer(bufferSize);
      const dv = new DataView(ab);
      let offset = 0;

      function writeString(s) { for (let i=0; i<s.length; i++) dv.setUint8(offset++, s.charCodeAt(i)); }
      function writeUint32(v){ dv.setUint32(offset, v, true); offset += 4; }
      function writeUint16(v){ dv.setUint16(offset, v, true); offset += 2; }

      writeString('RIFF'); writeUint32(36 + dataSize); writeString('WAVE');
      writeString('fmt '); writeUint32(16); writeUint16(1); // PCM
      writeUint16(numCh); writeUint32(sampleRate); writeUint32(sampleRate * blockAlign);
      writeUint16(blockAlign); writeUint16(16);
      writeString('data'); writeUint32(dataSize);

      // interleave & convert
      const channels = [];
      for (let ch=0; ch<numCh; ch++) channels.push(buffer.getChannelData(ch));
      for (let i=0; i<numFrames; i++){
        for (let ch=0; ch<numCh; ch++){
          let sample = Math.max(-1, Math.min(1, channels[ch][i]));
          sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
          dv.setInt16(offset, sample, true);
          offset += 2;
        }
      }
      return new Blob([ab], {type: 'audio/wav'});
    }

    // --- UI elements
    const fileEl = document.getElementById('file');
    const presetEl = document.getElementById('preset');
    const delayEl = document.getElementById('delayMs');
    const wetEl = document.getElementById('wet');
    const fbEl = document.getElementById('fb');
    const hpEl = document.getElementById('hp');
    const lpEl = document.getElementById('lp');
    const hissEl = document.getElementById('hiss');

    const labels = {
      delayLabel: document.getElementById('delayLabel'),
      wetLabel: document.getElementById('wetLabel'),
      fbLabel: document.getElementById('fbLabel'),
      hpLabel: document.getElementById('hpLabel'),
      lpLabel: document.getElementById('lpLabel'),
      hissLabel: document.getElementById('hissLabel'),
    };

    const labelMap = { delayMs: 'delayLabel', wet: 'wetLabel', fb: 'fbLabel', hp: 'hpLabel', lp: 'lpLabel', hiss: 'hissLabel' };
    [delayEl,wetEl,fbEl,hpEl,lpEl,hissEl].forEach(inp=>{
      const labelId = labelMap[inp.id];
      inp.addEventListener('input', ()=> labels[labelId].textContent = inp.value);
    });

    let audioCtx, srcBuffer, previewNodes = [], noiseNode, stopPreviewFn = null;

    function applyPresetDefaults() {
      const p = presetEl.value;
      if (p === 'raw')      { hpEl.value=20; lpEl.value=8000; delayEl.value=20; wetEl.value=0.00; fbEl.value=0.00; hissEl.value=0.00; }
      if (p === 'newsroom') { hpEl.value=100; lpEl.value=5000; delayEl.value=80; wetEl.value=0.30; fbEl.value=0.05; hissEl.value=0.00; }
      if (p === 'oldtv')    { hpEl.value=300; lpEl.value=3000; delayEl.value=110; wetEl.value=0.32; fbEl.value=0.12; hissEl.value=0.00; }
      if (p === 'oldtv_hiss'){hpEl.value=300; lpEl.value=3000; delayEl.value=110; wetEl.value=0.32; fbEl.value=0.12; hissEl.value=0.04; }
      [delayEl,wetEl,fbEl,hpEl,lpEl,hissEl].forEach(inp=>{
        const labelId = labelMap[inp.id];
        labels[labelId].textContent = inp.value;
      });
    }
    presetEl.addEventListener('change', applyPresetDefaults);
    applyPresetDefaults();

    // Load sample audio
    document.getElementById('loadSampleBtn').addEventListener('click', async (e) => {
      const btn = e.target;
      const originalText = btn.textContent;
      try {
        btn.textContent = 'Loading...';
        btn.disabled = true;

        // Create AudioContext on user gesture for mobile Safari
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          console.log('Created new AudioContext, state:', audioCtx.state);
        } else {
          audioCtx.close();
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          console.log('Recreated AudioContext, state:', audioCtx.state);
        }

        // Resume immediately on mobile Safari
        if (audioCtx.state === 'suspended') {
          await audioCtx.resume();
          console.log('Resumed AudioContext during load, new state:', audioCtx.state);
        }

        const response = await fetch('sample.mp3');
        if (!response.ok) throw new Error('Failed to fetch audio');

        const arrayBuffer = await response.arrayBuffer();
        console.log('Fetched audio buffer, size:', arrayBuffer.byteLength);

        srcBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        console.log('Decoded audio, duration:', srcBuffer.duration, 'channels:', srcBuffer.numberOfChannels);

        document.getElementById('previewBtn').disabled = false;
        document.getElementById('renderBtn').disabled = false;
        btn.textContent = '‚úì Sample Loaded';
        btn.style.background = '#059669';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = originalText;
          btn.style.background = '#10b981';
        }, 2000);
      } catch (error) {
        console.error('Failed to load sample audio:', error);
        alert('Error loading sample: ' + error.message);
        btn.textContent = '‚úó Load Failed';
        btn.style.background = '#ef4444';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = originalText;
          btn.style.background = '#10b981';
        }, 2000);
      }
    });

    fileEl.addEventListener('change', async () => {
      if (!fileEl.files[0]) return;
      const arr = await fileEl.files[0].arrayBuffer();
      audioCtx?.close();
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      srcBuffer = await audioCtx.decodeAudioData(arr.slice(0));
      document.getElementById('previewBtn').disabled = false;
      document.getElementById('renderBtn').disabled = false;
    });

    function buildGraph(ctx, buffer, {hpHz, lpHz, delayMs, wet, feedback, makeMono, addHiss, hissLevel}) {
      const nodes = [];

      // source
      const src = new AudioBufferSourceNode(ctx, { buffer });
      nodes.push(src);

      // optional mono fold-down (pre-filter)
      let head = src;
      if (makeMono && buffer.numberOfChannels > 1) {
        const splitter = new ChannelSplitterNode(ctx, { numberOfOutputs: 2 });
        const gL = new GainNode(ctx, { gain: 0.5 });
        const gR = new GainNode(ctx, { gain: 0.5 });
        const merger = new ChannelMergerNode(ctx, { numberOfInputs: 2 });
        head.connect(splitter);
        splitter.connect(gL, 0);
        splitter.connect(gR, 1);
        gL.connect(merger, 0, 0);
        gR.connect(merger, 0, 0); // sum to one channel
        // dual-mono out
        const dupe = new ChannelMergerNode(ctx, { numberOfInputs: 2 });
        merger.connect(dupe, 0, 0);
        merger.connect(dupe, 0, 1);
        head = dupe;
        nodes.push(splitter,gL,gR,merger,dupe);
      }

      // band-limit
      const hp = new BiquadFilterNode(ctx, { type: 'highpass', frequency: hpHz, Q: 0.707 });
      const lp = new BiquadFilterNode(ctx, { type: 'lowpass',  frequency: lpHz, Q: 0.707 });
      head.connect(hp); hp.connect(lp);
      nodes.push(hp, lp);
      head = lp;

      // compressor to tame peaks (broadcast-ish)
      const comp = new DynamicsCompressorNode(ctx, {
        threshold: -18, knee: 6, ratio: 3.5, attack: 0.003, release: 0.25
      });
      head.connect(comp);
      nodes.push(comp);
      head = comp;

      // create dry/wet paths with feedback delay
      const out = new GainNode(ctx, { gain: 1.0 }); nodes.push(out);

      const dry = new GainNode(ctx, { gain: 1.0 }); head.connect(dry); dry.connect(out); nodes.push(dry);
      const wetIn = new GainNode(ctx, { gain: 1.0 }); head.connect(wetIn); nodes.push(wetIn);
      const delay = new DelayNode(ctx, { delayTime: delayMs / 1000 });
      const fb = new GainNode(ctx, { gain: feedback });
      const wetGain = new GainNode(ctx, { gain: wet });
      // feedback loop
      wetIn.connect(delay); delay.connect(fb); fb.connect(delay);
      delay.connect(wetGain); wetGain.connect(out);
      nodes.push(delay, fb, wetGain);

      // optional hiss (white noise)
      let hissSrc = null;
      if (addHiss && hissLevel > 0) {
        const dur = buffer.duration + 1.0;
        const noiseBuf = ctx.createBuffer(1, Math.ceil(dur*ctx.sampleRate), ctx.sampleRate);
        const data = noiseBuf.getChannelData(0);
        for (let i=0;i<data.length;i++) data[i] = (Math.random()*2 - 1) * hissLevel;
        hissSrc = new AudioBufferSourceNode(ctx, { buffer: noiseBuf, loop: false });
        hissSrc.connect(out);
      }

      return { src, out, nodes, hissSrc };
    }

    async function startPreview() {
      if (!audioCtx || !srcBuffer) {
        console.error('Cannot start preview: audioCtx or srcBuffer missing');
        alert('Please load audio first');
        return;
      }

      try {
        // Resume AudioContext for mobile Safari
        console.log('AudioContext state before resume:', audioCtx.state);
        if (audioCtx.state === 'suspended') {
          await audioCtx.resume();
          console.log('AudioContext resumed, new state:', audioCtx.state);
        }

        stopPreview();
        const params = currentParams();
        console.log('Building graph with params:', params);

        const graph = buildGraph(audioCtx, srcBuffer, params);
        graph.out.connect(audioCtx.destination);

        console.log('Starting audio playback...');
        graph.src.start();
        if (graph.hissSrc) graph.hissSrc.start();

        previewNodes = graph.nodes;
        stopPreviewFn = () => {
          try { graph.src.stop(); } catch(e) { console.log('Error stopping src:', e); }
          try { graph.hissSrc && graph.hissSrc.stop(); } catch(e) { console.log('Error stopping hiss:', e); }
          previewNodes.forEach(n => { try { n.disconnect(); } catch(_) {} });
          previewNodes = []; stopPreviewFn = null;
        };
        document.getElementById('stopBtn').disabled = false;
        console.log('Preview started successfully');
      } catch (error) {
        console.error('Error in startPreview:', error);
        alert('Error playing audio: ' + error.message);
      }
    }

    function stopPreview(){
      if (stopPreviewFn) stopPreviewFn();
      document.getElementById('stopBtn').disabled = true;
    }

    async function renderWav(){
      if (!srcBuffer) return;

      // Resume AudioContext for mobile Safari (if needed for future operations)
      if (audioCtx && audioCtx.state === 'suspended') {
        await audioCtx.resume();
      }

      stopPreview();

      const params = currentParams();
      const nCh = srcBuffer.numberOfChannels;
      const sampleRate = srcBuffer.sampleRate;
      const offline = new OfflineAudioContext(nCh, srcBuffer.length, sampleRate);

      const g = buildGraph(offline, srcBuffer, params);
      g.out.connect(offline.destination);
      g.src.start(0);
      if (g.hissSrc) g.hissSrc.start(0);

      const rendered = await offline.startRendering();
      const blob = audioBufferToWavBlob(rendered);
      const url = URL.createObjectURL(blob);
      const a = document.getElementById('dl');
      a.href = url; a.download = `broadcast_${presetEl.value}.wav`;
      a.textContent = 'Download WAV';
    }

    function currentParams(){
      return {
        hpHz: parseFloat(hpEl.value),
        lpHz: parseFloat(lpEl.value),
        delayMs: parseFloat(delayEl.value),
        wet: parseFloat(wetEl.value),
        feedback: parseFloat(fbEl.value),
        makeMono: presetEl.value !== 'newsroom',
        addHiss: presetEl.value === 'oldtv_hiss',
        hissLevel: parseFloat(hissEl.value)
      };
    }

    document.getElementById('previewBtn').addEventListener('click', startPreview);
    document.getElementById('stopBtn').addEventListener('click', stopPreview);
    document.getElementById('renderBtn').addEventListener('click', renderWav);
  </script>
</body>
</html>
